<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
      xmlns:http="http://www.mulesoft.org/schema/mule/http"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
        http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <munit:config name="payment-success-test.xml"/>

    <!-- =========================================================
         Test: Payment Authorization Success
         Scenario: Valid payment request results in authorized payment
         ========================================================= -->
    <munit:test name="payment-success-test" 
                description="Test successful payment authorization with valid request"
                doc:name="Payment Success Test">
        
        <!-- Behavior: Setup mocks -->
        <munit:behavior>
            <!-- Mock Payment Gateway HTTP Request -->
            <munit-tools:mock-when processor="http:request" doc:name="Mock Payment Gateway Success">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute attributeName="doc:name" whereValue="Payment Gateway Request"/>
                </munit-tools:with-attributes>
                <munit-tools:then-return>
                    <munit-tools:payload value="#[MunitTools::getResourceAsString('gateway-response-success.json')]" mediaType="application/json" encoding="UTF-8"/>
                    <munit-tools:attributes value="#[{statusCode: 200}]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
        </munit:behavior>
        
        <!-- Execution: Call the flow -->
        <munit:execution>
            <munit:set-event doc:name="Set Valid Payment Request">
                <munit:payload value="#[MunitTools::getResourceAsString('payment-request-success.json')]" mediaType="application/json" encoding="UTF-8"/>
                <munit:attributes value="#[{
                    headers: {
                        'client_id': 'test-client-id',
                        'client_secret': 'test-client-secret',
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    requestPath: '/api/v1/payments',
                    requestUri: '/api/v1/payments'
                }]"/>
            </munit:set-event>
            
            <flow-ref name="post:\payments:application\json:Payment_System_API_Config" doc:name="Call Payment Flow"/>
        </munit:execution>
        
        <!-- Validation: Assert results -->
        <munit:validation>
            <!-- Assert HTTP Status is 201 -->
            <munit-tools:assert-that 
                expression="#[vars.httpStatus]" 
                is="#[MunitTools::equalTo(201)]" 
                message="Expected HTTP status 201 for successful payment"
                doc:name="Assert HTTP Status 201"/>
            
            <!-- Assert Payment Status is AUTHORIZED -->
            <munit-tools:assert-that 
                expression="#[payload.status]" 
                is="#[MunitTools::equalTo('AUTHORIZED')]" 
                message="Expected payment status to be AUTHORIZED"
                doc:name="Assert Status AUTHORIZED"/>
            
            <!-- Assert PaymentId is present -->
            <munit-tools:assert-that 
                expression="#[payload.paymentId]" 
                is="#[MunitTools::notNullValue()]" 
                message="Expected paymentId to be present"
                doc:name="Assert PaymentId Present"/>
            
            <!-- Assert PolicyId matches request -->
            <munit-tools:assert-that 
                expression="#[payload.policyId]" 
                is="#[MunitTools::equalTo('POL-998877')]" 
                message="Expected policyId to match request"
                doc:name="Assert PolicyId Matches"/>
            
            <!-- Assert Authorization Code is present -->
            <munit-tools:assert-that 
                expression="#[payload.authorizationCode]" 
                is="#[MunitTools::notNullValue()]" 
                message="Expected authorizationCode to be present"
                doc:name="Assert AuthCode Present"/>
            
            <!-- Assert Success Message -->
            <munit-tools:assert-that 
                expression="#[payload.message]" 
                is="#[MunitTools::containsString('authorized')]" 
                message="Expected success message"
                doc:name="Assert Success Message"/>
        </munit:validation>
    </munit:test>

    <!-- =========================================================
         Test: Payment Authorization with ACH Payment Method
         Scenario: Valid ACH payment request results in authorized payment
         ========================================================= -->
    <munit:test name="payment-success-ach-test" 
                description="Test successful payment authorization with ACH payment method"
                doc:name="Payment Success ACH Test">
        
        <munit:behavior>
            <munit-tools:mock-when processor="http:request" doc:name="Mock Payment Gateway ACH Success">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute attributeName="doc:name" whereValue="Payment Gateway Request"/>
                </munit-tools:with-attributes>
                <munit-tools:then-return>
                    <munit-tools:payload value="#[MunitTools::getResourceAsString('gateway-response-success.json')]" mediaType="application/json" encoding="UTF-8"/>
                    <munit-tools:attributes value="#[{statusCode: 200}]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
        </munit:behavior>
        
        <munit:execution>
            <munit:set-event doc:name="Set ACH Payment Request">
                <munit:payload value='#[output application/json --- {
                    "policyId": "POL-112233",
                    "amount": 250.00,
                    "currency": "USD",
                    "paymentMethod": {
                        "type": "ACH",
                        "token": "ach_tok_xyz789"
                    }
                }]' mediaType="application/json" encoding="UTF-8"/>
                <munit:attributes value="#[{
                    headers: {
                        'client_id': 'test-client-id',
                        'client_secret': 'test-client-secret',
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    requestPath: '/api/v1/payments',
                    requestUri: '/api/v1/payments'
                }]"/>
            </munit:set-event>
            
            <flow-ref name="post:\payments:application\json:Payment_System_API_Config" doc:name="Call Payment Flow"/>
        </munit:execution>
        
        <munit:validation>
            <munit-tools:assert-that 
                expression="#[vars.httpStatus]" 
                is="#[MunitTools::equalTo(201)]" 
                message="Expected HTTP status 201"
                doc:name="Assert HTTP Status 201"/>
            
            <munit-tools:assert-that 
                expression="#[payload.status]" 
                is="#[MunitTools::equalTo('AUTHORIZED')]" 
                message="Expected status AUTHORIZED"
                doc:name="Assert Status AUTHORIZED"/>
            
            <munit-tools:assert-that 
                expression="#[payload.policyId]" 
                is="#[MunitTools::equalTo('POL-112233')]" 
                message="Expected policyId POL-112233"
                doc:name="Assert PolicyId"/>
        </munit:validation>
    </munit:test>

</mule>
